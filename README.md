# Домашнее задание к занятию «Резервное копирование баз данных» - Малявко Сергей (netology)

### Задание 1. Резервное копирование

Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Приведите ответ в свободной форме.

### Выполнение задания 1

#### **1.1. Восстановление данных в полном объёме за предыдущий день**  
Подходящий вариант: **Полное резервное копирование (Full Backup)**.  
- **Почему?** Полный бэкап содержит все данные на момент его создания.  
- **Как часто?** Ежедневно, желательно в период минимальной нагрузки (например, ночью).  
- **Особенности:**  
  - Требует больше места и времени по сравнению с инкрементными/дифференциальными бэкапами.  
  - Простота восстановления: нужен только один файл резервной копии.  

#### **1.2. Восстановление данных за час до поломки**  
Подходящий вариант: **Комбинация полного + инкрементного/дифференциального копирования**.  
- **Полный бэкап** (раз в день) + **инкрементные** (каждый час) — экономит место, но восстановление сложнее (нужна цепочка бэкапов).  
- **Полный бэкап** + **дифференциальные** (раз в несколько часов) — быстрее восстановление, но занимает больше места.  
- **Транзакционные логи (Transaction Log Backup)** — для СУБД, поддерживающих журнал транзакций (например, SQL Server, PostgreSQL). Позволяет восстановить базу до конкретного момента времени (Point-in-Time Recovery).  

#### **1.3.* Моментальное переключение на работающую базу при поломке**  
**Да, такое возможно с использованием:**  
- **Репликации (Master-Slave, Master-Master)**  
  - **Hot Standby** — резервная БД постоянно синхронизируется с основной.  
  - **Автоматический failover** (например, PostgreSQL + Patroni, MySQL с Group Replication).  
- **Кластерные решения** (например, MongoDB Replica Set, Redis Sentinel).  
- **Балансировщики нагрузки** (переключают трафик на рабочую ноду).  

### **Итог:**  
- Для полного восстановления за день — **Full Backup**.  
- Для восстановления за час — **Full + Incremental/Differential или Transaction Logs**.  
- Для мгновенного переключения — **репликация + автоматический failover**.  

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).
2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Приведите ответ в свободной форме.

### Выполнение задания 2

### **2.1. Резервирование и восстановление в PostgreSQL**  

#### **Резервное копирование (pg_dump)**  
**Полный дамп одной базы:**  
```bash
pg_dump -U username -d dbname -F c -f /backup/dbname_backup.dump
```
- `-U username` — пользователь PostgreSQL.  
- `-d dbname` — имя базы данных.  
- `-F c` — формат `custom` (сжатый, поддерживает pg_restore).  
- `-f /backup/dbname_backup.dump` — путь к файлу бэкапа.  

**Дамп всей кластера (всех БД):**  
```bash
pg_dumpall -U postgres -f /backup/full_backup.sql
```
- `pg_dumpall` создаёт SQL-скрипт для восстановления всех БД, ролей и прав.  

---

#### **Восстановление (pg_restore)**  
**Восстановление в новую БД:**  
```bash
pg_restore -U username -d new_dbname -C /backup/dbname_backup.dump
```
- `-C` — создаёт БД перед восстановлением.  

**Восстановление с заменой существующей БД:**  
```bash
dropdb -U username dbname && createdb -U username dbname  
pg_restore -U username -d dbname /backup/dbname_backup.dump
```

**Восстановление из pg_dumpall:**  
```bash
psql -U postgres -f /backup/full_backup.sql
```

---

### **2.1.* Автоматизация резервного копирования**  

#### **Cron-задания**  
Добавьте задание в `crontab -e` для ежедневного бэкапа:  
```bash
0 2 * * * pg_dump -U postgres -d mydb -F c -f /backups/mydb_$(date +\%Y-\%m-\%d).dump
```
- Бэкап каждый день в 2:00.  
- Имя файла включает дату (`%Y-%m-%d`).  

### **Итог**  
- **Резервирование:** `pg_dump` (отдельная БД) или `pg_dumpall` (весь кластер).  
- **Восстановление:** `pg_restore` (для `-F c`) или `psql` (для SQL-дампов).  
- **Автоматизация:** через **cron**.  
